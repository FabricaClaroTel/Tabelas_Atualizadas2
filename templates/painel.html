<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Atualizações</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 40px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    canvas { max-width: 100%; }
  </style>
</head>
<body>

  <h2>Atualizações da Tabela (CSV)</h2>

  <table>
    <thead>
      <tr>
        <th>BASE</th>
        <th>DT_BASE</th>
        <th>DATA_IMPORT</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for row in data %}
      <tr>
        <td>{{ row.BASE }}</td>
        <td>{{ row.DT_BASE }}</td>
        <td>{{ row.DATA_IMPORT }}</td>
        <td>
          {% if row.DATA_IMPORT >= row.DT_BASE %}
            ✔️
          {% else %}
            ❌
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Gráfico -->
  <h2>Gráfico de Atualizações</h2>
  <canvas id="grafico" width="800" height="400"></canvas>

  <script>
    // Dados passados do Flask para JavaScript
    const data = {{ data|tojson }};

    // Função para converter 'dd/mm/yyyy' para dias desde 01/01/2025
    const toDays = (dateStr) => {
      const [day, month, year] = dateStr.split('/');
      const date = new Date(`${year}-${month}-${day}`);
      const ref = new Date('2025-01-01');
      return Math.floor((date - ref) / (1000 * 60 * 60 * 24));
    };

    const labels = data.map(row => row.BASE);
    const dtBaseData = data.map(row => toDays(row.DT_BASE));
    const dataImportData = data.map(row => toDays(row.DATA_IMPORT));

    const ctx = document.getElementById('grafico').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'DT_BASE (dias desde 01/01/2025)',
            data: dtBaseData,
            backgroundColor: 'rgba(255, 99, 132, 0.6)'
          },
          {
            label: 'DATA_IMPORT (dias desde 01/01/2025)',
            data: dataImportData,
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            title: {
              display: true,
              text: 'Dias desde 01/01/2025'
            }
          }
        }
      }
    });
  </script>

</body>
</html>
